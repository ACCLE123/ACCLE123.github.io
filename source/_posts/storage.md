---
title: storage
date: 2024-07-28 14:38:32
tags:
---


### 存储架构

```bash
register -> cache1 -> cache2 -> cache3 -> RAM -> SSD
```


DDR3 的读写速度 约为 10GB/s

SSD 的读写速度 约为 300MB/s


### 内存管理

我们已经有了物理的内存条

我们需要为每一个进程分配内存

#### 设计思路1

每一个进程分配固定的 物理内存

缺陷：
1. 内存分配过大 造成物理内存浪费
2. 内存分配过小 
3. 每个进程分配到的内存地址 不固定

#### 设计思路2

为每一个进程分配一个4G的虚拟内存 (32位地址空间)

每个进程的虚拟内存独立

#### 页page

地址结构:  ` 页号 + 页内偏移 `

一个页大小为4KB (页内偏移 page offset 为12位)

页表page table

页表中存有页表项 page table entry

#### sv39

SV39（Sv39）是RISC-V架构中一种常用的虚拟内存寻址模式

sv39是三级页表结构

虚拟地址: 9 + 9 + 9 + 12

寻址过程:

1. satp寄存器 (根页表寄存器) (一级页表) + 前9个bit -> 2级页表物理地址
2. 2级页表 + 中9个bit -> 3级页表物理地址
3. 3级页表 + 后9个bit -> 物理页号
4. 物理页号 + 12个bit (page offset) -> 物理页号

整个过程由mmu(cpu中的一个物理硬件)进行完成

#### 缺页异常

每一个pte中有一个有效为 记录 物理页号是否有效

当发现物理页号 无效时 会触发缺页异常

异常处理步骤:
1. cpu发现缺页异常
2. 检查虚拟地址合法性(若不合法 抛出segment fault异常)
3. 分配物理内存(假如物理内存满 需要采取一种 **页面置换算法** 来换入换出)
4. 更新页表
5. 恢复进程执行

#### 页表大小

sv39中 一个page table 为4KB (一个page的大小)

一个page table entry 大小为 8B

一个page table 有 $2^9$个pte

页太大: 
1. 容易造成浪费

页太小:
1. 频繁的换入换出
2. 增大page table的大小